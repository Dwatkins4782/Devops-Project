---
# Master Playbook for Infrastructure Configuration
# This orchestrates all configuration management tasks

- name: Site-wide Configuration
  hosts: all
  become: yes
  gather_facts: yes
  
  pre_tasks:
    - name: Display environment information
      debug:
        msg: "Configuring {{ inventory_hostname }} in {{ environment }} environment"

    - name: Update package cache (Debian/Ubuntu)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Update package cache (RedHat/CentOS)
      yum:
        update_cache: yes
      when: ansible_os_family == "RedHat"

  roles:
    - role: common
      tags: [common, base]
    
    - role: monitoring-agent
      tags: [monitoring, observability]

# Linux Systems Hardening
- name: Configure Linux Systems
  hosts: linux
  become: yes
  gather_facts: yes
  
  roles:
    - role: linux-baseline
      tags: [linux, hardening, cis]
    
    - role: vault-agent
      tags: [vault, secrets]
      when: enable_vault | default(false)

# Windows Systems Hardening
- name: Configure Windows Systems
  hosts: windows
  gather_facts: yes
  
  roles:
    - role: windows-baseline
      tags: [windows, hardening, cis]

# Application Servers
- name: Configure Application Servers
  hosts: app_servers
  become: yes
  gather_facts: yes
  
  roles:
    - role: app-server
      tags: [application, deployment]

# Post-Configuration Validation
- name: Validate Configuration
  hosts: all
  become: yes
  gather_facts: no
  
  tasks:
    - name: Verify monitoring agent is running
      service:
        name: "{{ monitoring_agent_service }}"
        state: started
        enabled: yes
      tags: [validation, monitoring]

    - name: Check security baseline compliance
      command: "{{ compliance_check_command }}"
      register: compliance_result
      changed_when: false
      failed_when: compliance_result.rc != 0
      tags: [validation, security]

    - name: Generate compliance report
      template:
        src: compliance-report.j2
        dest: /var/log/compliance-report.json
        mode: '0644'
      tags: [reporting]
