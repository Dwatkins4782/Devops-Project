name: CI/CD Pipeline (Build, Push, Deploy)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  REGISTRY: localhost:5555
  IMAGE_NAME: devops-app
  CLUSTER_NAME: devops-cluster

jobs:
  build-push-deploy:
    name: Build → Push → Deploy to KinD
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up KinD
        uses: helm/kind-action@v1.10.0
        with:
          version: v0.20.0

      - name: Start local registry
        run: |
          docker run -d --restart=always -p 5555:5000 --name kind-registry registry:2 || true
          docker network connect kind kind-registry 2>/dev/null || true

      - name: Create KinD cluster
        run: |
          kind create cluster --name ${CLUSTER_NAME} --config - <<EOF
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
          - role: worker
          EOF

      - name: Build Docker image
        run: |
          docker build -t ${REGISTRY}/${IMAGE_NAME}:${GITHUB_SHA} ./app
          docker build -t ${REGISTRY}/${IMAGE_NAME}:latest ./app

      - name: Push to local registry
        run: |
          docker push ${REGISTRY}/${IMAGE_NAME}:${GITHUB_SHA}
          docker push ${REGISTRY}/${IMAGE_NAME}:latest

      - name: Load image into KinD
        run: |
          kind load docker-image ${REGISTRY}/${IMAGE_NAME}:${GITHUB_SHA} --name ${CLUSTER_NAME}
          kind load docker-image ${REGISTRY}/${IMAGE_NAME}:latest --name ${CLUSTER_NAME}

      - name: Deploy observability (Prometheus + Grafana)
        run: |
          kind get kubeconfig --name ${CLUSTER_NAME} > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
          kubectl create namespace monitoring || true
          helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
            --namespace monitoring \
            --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
            --set prometheus.prometheusSpec.maximumStartupDurationSeconds=300 \
            --set grafana.service.type=NodePort \
            --set grafana.service.nodePort=30000 \
            --wait --timeout 10m

      - name: Deploy application with Helm
        run: |
          kind get kubeconfig --name ${CLUSTER_NAME} > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          kubectl create namespace app || true
          helm upgrade --install devops-app ./helm/app \
            --namespace app \
            --set image.repository=${REGISTRY}/${IMAGE_NAME} \
            --set image.tag=${GITHUB_SHA} \
            --set serviceMonitor.enabled=true \
            --wait --timeout 5m

      - name: Verify deployment
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          kubectl wait --for=condition=available --timeout=300s deployment/devops-app -n app
          kubectl get pods -n app
          kubectl get svc -n app
